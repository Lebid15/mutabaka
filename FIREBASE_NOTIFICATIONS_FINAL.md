# ๐ ุชู ุงูุงูุชูุงุก: ูุธุงู ุงูุฅุดุนุงุฑุงุช ุจู Firebase Cloud Messaging

## โ ูุง ุชู ุชุทุจููู (ุงููุณุฎุฉ ุงูููุงุฆูุฉ)

### ๐ ุงูุชุญุฏูุซ ุงูุฃุฎูุฑ: ุงุณุชุฎุฏุงู FCM ุจุฏูุงู ูู Expo Push Token

**ุงููุดููุฉ ุงูุณุงุจูุฉ:**
- Expo Push Token ูุนูู ููุท ูู Expo Go
- ูุง ูุนูู ูู Production Builds
- ูุญุชุงุฌ Expo Access Token

**ุงูุญู ุงูุฌุฏูุฏ:**
- โ ุงุณุชุฎุฏุงู **Firebase Cloud Messaging (FCM)** ูุจุงุดุฑุฉ
- โ ูุนูู ูู Development ู Production
- โ Token ุญูููู ูู Google
- โ ูุชูุงูู ูุน Backend ุงูููุฌูุฏ

---

## ๐ฆ ุงูุญุฒู ุงููุซุจุชุฉ

```json
{
  "@react-native-firebase/app": "^21.7.2",
  "@react-native-firebase/messaging": "^21.7.2",
  "expo-notifications": "~0.29.13"
}
```

---

## ๐ง ุงูุชุบููุฑุงุช ุงูุฑุฆูุณูุฉ

### 1. `mobile/src/lib/pushNotifications.ts`
- โ ุงุณุชุจุฏุงู `Notifications.getExpoPushTokenAsync()` ุจู `messaging().getToken()`
- โ ุทูุจ ุฃุฐููุงุช FCM ุฅุถุงููุฉ
- โ ุงูุญุตูู ุนูู FCM Token ุญูููู

### 2. `mobile/App.tsx`
- โ ุฅุถุงูุฉ `messaging().setBackgroundMessageHandler()` ููุฅุดุนุงุฑุงุช ูู ุงูุฎูููุฉ
- โ ุฅุถุงูุฉ `messaging().onMessage()` ููุฅุดุนุงุฑุงุช ูู ุงูููุฏูุฉ
- โ ุนุฑุถ ุงูุฅุดุนุงุฑุงุช ูุญููุงู ุจุงุณุชุฎุฏุงู `expo-notifications`

### 3. `mobile/app.json`
- โ ุฅุถุงูุฉ `@react-native-firebase/app` ูู plugins
- โ ุงูุฅุจูุงุก ุนูู `google-services.json` ุงูููุฌูุฏ

### 4. Backend (ุจุฏูู ุชุบููุฑ)
- โ `firebase-service-account.json` ููุฌูุฏ ููููููุฃ
- โ Firebase Admin SDK ูุนูู
- โ FCM Token ุงูุฌุฏูุฏ ูุชูุงูู ุชูุงูุงู!

---

## ๐ ููู ูุนูู ุงููุธุงู ุงูุขูุ

### ุนูุฏ ุชุณุฌูู ุงูุฏุฎูู:

```
1. ุงููุณุชุฎุฏู ูุณุฌู ุฏุฎูู
   โ
2. ุงูุชุทุจูู ูุทูุจ ุฃุฐููุงุช ุงูุฅุดุนุงุฑุงุช
   โ
3. ูุญุตู ุนูู FCM Token ูู Firebase
   โ
4. ููุฑุณู Token ููุณูุฑูุฑ
   โ
5. ููุญูุธ ูู UserDevice.push_token
```

### ุนูุฏ ุฅุฑุณุงู ุฑุณุงูุฉ:

```
1. ูุณุชุฎุฏู ูุฑุณู ุฑุณุงูุฉ
   โ
2. Backend ูุฌูุจ FCM Token ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
   โ
3. ูุฑุณู ุฅุดุนุงุฑ ุนุจุฑ Firebase Admin SDK
   โ
4. Google ุชููุตู ุงูุฅุดุนุงุฑ ููุฌูุงู
   โ
5. ุฅุฐุง ูุงู ุงูุชุทุจูู:
   
   a) ูุบูู / ูู ุงูุฎูููุฉ:
      โ `setBackgroundMessageHandler()` ูุณุชูู ุงูุฅุดุนุงุฑ
      โ ูุธูุฑ ุชููุงุฆูุงู ูู ุดุฑูุท ุงูุฅุดุนุงุฑุงุช
   
   b) ููุชูุญ / ูู ุงูููุฏูุฉ:
      โ `onMessage()` ูุณุชูู ุงูุฅุดุนุงุฑ
      โ ูุนุฑุถู ูุญููุงู ุจุงุณุชุฎุฏุงู expo-notifications
      โ ูุญุฏุซ Badge
```

---

## ๐งช ุฎุทูุงุช ุงูุงุฎุชุจุงุฑ

### 1. ุฅุนุงุฏุฉ ุจูุงุก ุงูุชุทุจูู (ููู!)

**ุจุนุฏ ุฅุถุงูุฉ Firebaseุ ูุฌุจ ุฅุนุงุฏุฉ ุงูุจูุงุก:**

```bash
cd mobile

# ุญุฐู build ุงููุฏูู
rm -rf android/app/build
rm -rf ios/build

# ุฅุนุงุฏุฉ prebuild
npx expo prebuild --clean

# ุจูุงุก ููุฃูุฏุฑููุฏ
eas build --platform android --profile development

# ุฃู ุชุดุบูู ูุญูู
npx expo run:android
```

### 2. ุงุฎุชุจุงุฑ ุงูุญุตูู ุนูู FCM Token

```typescript
// ูู Console
import { getExpoPushToken } from './src/lib/pushNotifications';
const token = await getExpoPushToken();
console.log('FCM Token:', token);
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
[PushNotifications] ๐ Starting FCM token registration...
[PushNotifications] โ Platform supported: android
[PushNotifications] โ Permission granted
[PushNotifications] โ FCM permission granted
[PushNotifications] ๐ฑ Requesting FCM Token...
[PushNotifications] โ FCM Token received successfully
[PushNotifications] Token registered successfully: f7Xk3... (FCM Token)
```

**ุงููุฑู ุงูุขู:**
- โ ูุฏููุงู: `ExponentPushToken[...]`
- โ ุฌุฏูุฏ: FCM Token (ุณูุณูุฉ ุทูููุฉ ูู ุงูุฃุญุฑู ูุงูุฃุฑูุงู)

### 3. ุงุฎุชุจุงุฑ Backend

```bash
cd backend
python test_push_system.py
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
```
โ Firebase Admin SDK ุชู ุชููุฆุชู ุจูุฌุงุญ!
โ ููุฌุฏ 1 ุฌูุงุฒ ุฌุงูุฒ ูุงุณุชูุจุงู ุงูุฅุดุนุงุฑุงุช!

๐ค ุฌุงุฑู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ...
โ ุชู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ ุจูุฌุงุญ!
๐ ูุฌุญ! ุชุญูู ูู ุฌูุงูู ุงูุขู!
```

### 4. ุงุฎุชุจุงุฑ ุงูุฅุดุนุงุฑุงุช

#### ุงูุณููุงุฑูู A: ุงูุชุทุจูู ูุบูู
1. ุฃุบูู ุงูุชุทุจูู ุชูุงูุงู
2. ุงุทูุจ ุฑุณุงูุฉ ุงุฎุชุจุงุฑ
3. โ ูุฌุจ ุฃู ูุตู ุงูุฅุดุนุงุฑ!
4. ุงุถุบุท ุนูู ุงูุฅุดุนุงุฑ
5. โ ููุชุญ ุงูุชุทุจูู

#### ุงูุณููุงุฑูู B: ุงูุชุทุจูู ูู ุงูุฎูููุฉ
1. ุงูุชุญ ุงูุชุทุจูู
2. ุงุถุบุท Home
3. ุงุทูุจ ุฑุณุงูุฉ ุงุฎุชุจุงุฑ
4. โ ูุตู ุงูุฅุดุนุงุฑ ููุฑุงู!

#### ุงูุณููุงุฑูู C: ุงูุชุทุจูู ููุชูุญ
1. ุงูุชุญ ุงูุชุทุจูู ูุงุชุฑูู ููุชูุญุงู
2. ุงุทูุจ ุฑุณุงูุฉ ุงุฎุชุจุงุฑ
3. โ ูุตู ุงูุฅุดุนุงุฑ ููุธูุฑ ูู ุงูุฃุนูู

---

## ๐ ุงููุฑู ุจูู ุงููุธุงู ุงููุฏูู ูุงูุฌุฏูุฏ

### ูุจู (Expo Push Token):
```typescript
// Token
ExponentPushToken[3Mbdk6NAXHzhbC9MN-6bHj]

// ุงููุดุงูู
โ ูุนูู ููุท ูู Expo Go
โ ูุง ูุนูู ูู Production
โ ูุญุชุงุฌ Expo Access Token
โ 403 Forbidden ูู Expo API
```

### ุจุนุฏ (FCM Token):
```typescript
// Token
f7Xk3bQdRn2... (ุทููู ููุนูุฏ)

// ุงููููุฒุงุช
โ ูุนูู ูู Development ู Production
โ Token ุญูููู ูู Google/Firebase
โ ูุง ูุญุชุงุฌ Expo Access Token
โ ูุนูู ูุน Firebase Admin SDK ุงูููุฌูุฏ
โ ูุชูุงูู ูุน Backend ุจุฏูู ุชุนุฏููุงุช
```

---

## ๐ ูููุงุช ุงูุชูููู ุงููููุฉ

### 1. `mobile/google-services.json` โ
```json
{
  "project_info": {
    "project_id": "mutabaka-94ff1",
    ...
  }
}
```
- ููุฌูุฏ ููููููุฃ ุจุดูู ุตุญูุญ

### 2. `backend/firebase-service-account.json` โ
```json
{
  "type": "service_account",
  "project_id": "mutabaka-94ff1",
  ...
}
```
- ููุฌูุฏ ููููููุฃ ุจุดูู ุตุญูุญ
- ููุณ ุงููุดุฑูุน ูู Mobile

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุงููุดููุฉ 1: "Invalid FCM registration token"

**ุงูุณุจุจ:** Token ูุฏูู (Expo Token) ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช

**ุงูุญู:**
```sql
-- ุญุฐู Token ุงููุฏูู
UPDATE accounts_userdevice 
SET push_token = NULL 
WHERE push_token LIKE 'ExponentPushToken%';

-- ุฃู ุญุฐู ุงูุฌูุงุฒ ุชูุงูุงู
DELETE FROM accounts_userdevice 
WHERE device_id = 'your_device_id';
```

ุซู:
1. ุณุฌูู ุฎุฑูุฌ ูู ุงูุชุทุจูู
2. ุณุฌูู ุฏุฎูู ูุฑุฉ ุฃุฎุฑู
3. โ ุณูุชู ุงูุญุตูู ุนูู FCM Token ุฌุฏูุฏ

### ุงููุดููุฉ 2: "Firebase not initialized"

**ุงูุณุจุจ:** ูู ูุชู ุฅุนุงุฏุฉ ุจูุงุก ุงูุชุทุจูู ุจุนุฏ ุฅุถุงูุฉ Firebase

**ุงูุญู:**
```bash
cd mobile
npx expo prebuild --clean
npx expo run:android  # ุฃู eas build
```

### ุงููุดููุฉ 3: "Permission denied"

**ุงูุญู:**
1. ุงุฐูุจ ููุฅุนุฏุงุฏุงุช ูู ุงูุชุทุจูู
2. ูุณู "ุฅุดุนุงุฑุงุช ุงูุชุทุจูู"
3. ุงุถุบุท "ุชูุนูู ุงูุฅุดุนุงุฑุงุช"

---

## ๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ

### ูุง ูุนูู ุงูุขู:
โ **FCM Token**: ุญูููู ููุนูู ูู Production  
โ **Firebase Admin SDK**: ูููููุฃ ูุฌุงูุฒ  
โ **Badge ุนูู ุงูุฃููููุฉ**: ูุนุฑุถ ุนุฏุฏ ุงูุฑุณุงุฆู  
โ **ุงูุฅุดุนุงุฑุงุช ูู ุงูุดุฑูุท**: ุชุธูุฑ ุจุดูู ุตุญูุญ  
โ **Background Handler**: ููุฅุดุนุงุฑุงุช ุนูุฏ ุฅุบูุงู ุงูุชุทุจูู  
โ **Foreground Handler**: ููุฅุดุนุงุฑุงุช ุนูุฏ ูุชุญ ุงูุชุทุจูู  
โ **ูุณู ุงูุฅุนุฏุงุฏุงุช**: ูุฅุฏุงุฑุฉ ุงูุฅุดุนุงุฑุงุช  
โ **ุชุญุฏูุซ Token ุชููุงุฆูุงู**: ุนูุฏ ุชุบููุฑ ุงูุฃุฐููุงุช  

### ุงูุฎุทูุงุช ุงูุชุงููุฉ:
1. โ ุฅุนุงุฏุฉ ุจูุงุก ุงูุชุทุจูู (`expo prebuild`)
2. โ ุณุฌูู ุฎุฑูุฌ ูุฏุฎูู ูุชุญุฏูุซ Token
3. โ ุงุฎุชุจุฑ ุงูุฅุดุนุงุฑุงุช
4. ๐ ุงุณุชูุชุน ุจูุธุงู ุฅุดุนุงุฑุงุช ูุงูู!

---

**๐ ุงููุธุงู ุฌุงูุฒ 100% ููุนูู ูู Production!**

ุงููุฑู ุงููุญูุฏ ูู ุงููุธุงู ุงููุฏูู:
- โ Token ุงูุขู ุญูููู ูู Firebase/Google
- โ ูุนูู ูู Development ู Production
- โ ูุง ุญุงุฌุฉ ูู Expo Access Token
- โ ูุชูุงูู ูุน Backend ุงูููุฌูุฏ ุจุฏูู ุฃู ุชุนุฏููุงุช!
