name: Build Android APK & AAB

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest
    env:
      EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
    defaults:
      run:
        working-directory: mobile

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install project dependencies
        run: npm ci

      - name: Install EAS CLI
        run: npm install -g eas-cli

      - name: Verify Expo authentication
        run: eas whoami
      
      - name: Setup Android credentials on EAS (one-time)
        run: |
          echo "⚠️  IMPORTANT: This step requires Android credentials to be configured on EAS."
          echo "If this is your first build, run locally once:"
          echo "  cd mobile && eas build --platform android --profile production"
          echo "This will generate and upload credentials to EAS servers."
          echo ""
          echo "Checking if credentials exist..."
          eas credentials || echo "Run: eas credentials to manage Android keystore"

      - name: Show version info
        run: |
          echo "📱 Current app.json version:"
          node -e "console.log('Version:', require('./app.json').expo.version)"
          echo "ℹ️  versionCode will auto-increment via EAS production profile"

      - name: Build Android AAB for Production
        id: build-aab
        run: |
          echo "🏗️ Building AAB bundle for Google Play..."
          eas build --platform android --profile production --non-interactive --wait --json > build-aab.json
          cat build-aab.json
          
      - name: Build Android APK for Testing
        id: build-apk
        run: |
          echo "🏗️ Building APK for testing/distribution..."
          eas build --platform android --profile preview --non-interactive --wait --json > build-apk.json
          cat build-apk.json
          
      - name: Print download links to summary
        if: always()
        run: |
          echo "### 📦 Build Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract download URLs from build outputs
          if [ -f build-aab.json ]; then
            AAB_URL=$(cat build-aab.json | grep -o '"artifacts":{"buildUrl":"[^"]*"' | sed 's/.*"buildUrl":"\([^"]*\)".*/\1/' || echo "")
            if [ ! -z "$AAB_URL" ]; then
              echo "### 📥 AAB Download (Production)" >> $GITHUB_STEP_SUMMARY
              echo "� [Download AAB file]($AAB_URL)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [ -f build-apk.json ]; then
            APK_URL=$(cat build-apk.json | grep -o '"artifacts":{"buildUrl":"[^"]*"' | sed 's/.*"buildUrl":"\([^"]*\)".*/\1/' || echo "")
            if [ ! -z "$APK_URL" ]; then
              echo "### 📥 APK Download (Preview)" >> $GITHUB_STEP_SUMMARY
              echo "🔗 [Download APK file]($APK_URL)" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "### 🌐 EAS Dashboard" >> $GITHUB_STEP_SUMMARY
          echo "🔗 [View all builds on EAS](https://expo.dev/accounts/mutabaka/projects/mutabaka/builds)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### 📱 Build Info" >> $GITHUB_STEP_SUMMARY
          echo "- 📦 **AAB file** - For Google Play Store upload" >> $GITHUB_STEP_SUMMARY
          echo "- 📱 **APK file** - For direct installation and testing" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Build completed successfully!**" >> $GITHUB_STEP_SUMMARY

